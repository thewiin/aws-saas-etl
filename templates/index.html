<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS ETL & AI Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        #loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; }
    </style>
</head>
<body>

<div id="loading" class="text-center bg-white p-4 rounded shadow">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2 fw-bold">ƒêang x·ª≠ l√Ω...</p>
</div>

<div class="container mt-5">

    <div id="auth-section" class="row justify-content-center">
        <div class="col-md-5">
            <div class="card p-4 shadow-sm">

                <div id="login-form">
                    <h3 class="text-center mb-4 text-primary">‚òÅÔ∏è ƒêƒÉng Nh·∫≠p</h3>
                    <div class="mb-3">
                        <label>Username</label>
                        <input type="text" id="login-user" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Password</label>
                        <input type="password" id="login-pass" class="form-control">
                    </div>
                    <button onclick="login()" class="btn btn-primary w-100 mb-2">ƒêƒÉng nh·∫≠p</button>
                    <p class="text-center text-muted">
                        Ch∆∞a c√≥ t√†i kho·∫£n?
                        <a href="#" onclick="toggleAuth()" class="text-decoration-none">ƒêƒÉng k√Ω ngay</a>
                    </p>
                </div>

                <div id="register-form" class="hidden">
                    <h3 class="text-center mb-4 text-success">üìù T·∫°o T√†i Kho·∫£n</h3>
                    <div class="mb-3">
                        <label>Ch·ªçn Username</label>
                        <input type="text" id="reg-user" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Ch·ªçn Password</label>
                        <input type="password" id="reg-pass" class="form-control">
                    </div>
                    <button onclick="register()" class="btn btn-success w-100 mb-2">ƒêƒÉng k√Ω</button>
                    <p class="text-center text-muted">
                        ƒê√£ c√≥ t√†i kho·∫£n?
                        <a href="#" onclick="toggleAuth()" class="text-decoration-none">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                    </p>
                </div>

            </div>
        </div>
    </div>

    <div id="dashboard-section" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2> ETL & AI Dashboard</h2>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">ƒêƒÉng xu·∫•t</button>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card p-4 mb-4">
                    <h5 class="mb-3">1. Upload File (Extract)</h5>
                    <input type="file" id="fileInput" class="form-control mb-2">
                    <small class="text-muted d-block mb-3">H·ªó tr·ª£: .csv, .json</small>

                    <h5 class="mb-3">2. C·∫•u h√¨nh (Transform & AI)</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkClean" checked>
                        <label class="form-check-label">L√†m s·∫°ch d·ªØ li·ªáu (Clean)</label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="checkAI" checked>
                        <label class="form-check-label text-success fw-bold">Ph√¢n t√≠ch c·∫£m x√∫c (AI)</label>
                    </div>

                    <button onclick="uploadAndStart()" class="btn btn-success w-100 py-2">
                        ‚ñ∂ B·∫Øt ƒë·∫ßu Job
                    </button>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card p-4">
                    <div class="d-flex justify-content-between mb-3">
                        <h5>L·ªãch s·ª≠ Jobs (Load)</h5>
                        <button onclick="loadJobs()" class="btn btn-sm btn-outline-primary"> L√†m m·ªõi</button>
                    </div>

                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>T√™n File</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>K·∫øt qu·∫£</th>
                                <th>Th·ªùi gian</th>
                            </tr>
                        </thead>
                        <tbody id="jobTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = ''; // ƒê·ªãa ch·ªâ Flask Local

    function toggleAuth() {
        const loginForm = document.getElementById('login-form');
        const regForm = document.getElementById('register-form');

        if (loginForm.classList.contains('hidden')) {
            loginForm.classList.remove('hidden');
            regForm.classList.add('hidden');
        } else {
            loginForm.classList.add('hidden');
            regForm.classList.remove('hidden');
        }
    }

    async function register() {
        const user = document.getElementById('reg-user').value;
        const pass = document.getElementById('reg-pass').value;

        if (!user || !pass) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!");

        try {
            const res = await fetch(`${API_URL}/api/auth/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user, password: pass})
            });

            const data = await res.json();

            if (res.ok) {
                alert("‚úÖ " + data.message);
                toggleAuth(); // Chuy·ªÉn v·ªÅ m√†n h√¨nh ƒëƒÉng nh·∫≠p ƒë·ªÉ user login
            } else {
                alert("‚ùå L·ªói: " + data.message);
            }
        } catch (e) {
            console.error(e);
            alert("L·ªói k·∫øt n·ªëi Server!");
        }
    }

    // 1. H√†m ƒêƒÉng Nh·∫≠p
    async function login() {
        const user = document.getElementById('login-user').value;
        const pass = document.getElementById('login-pass').value;

        try {
            const res = await fetch(`${API_URL}/api/auth/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user, password: pass})
            });
            const data = await res.json();

            if (res.ok) {
                // ·∫®n khung auth, hi·ªán dashboard
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');

                // L∆∞u th√¥ng tin user t·∫°m th·ªùi v√†o localStorage ƒë·ªÉ d√πng sau n√†y (n·∫øu c·∫ßn)
                localStorage.setItem('current_user', user);

                loadJobs();
            } else {
                alert("‚ùå " + data.message);
            }
        } catch (e) { alert('L·ªói k·∫øt n·ªëi Backend!'); }
    }

    function logout() {
        location.reload();
    }

    // 2. H√†m Quan tr·ªçng: Upload l√™n S3 v√† Trigger Lambda
    async function uploadAndStart() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) return alert("Vui l√≤ng ch·ªçn file!");

        showLoading(true);

        try {
            // B1: Xin URL upload t·ª´ Backend
            console.log("ƒêang xin URL upload...");
            const urlRes = await fetch(`${API_URL}/api/jobs/upload_url`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({file_name: file.name})
            });
            const urlData = await urlRes.json();

            if (!urlData.url) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c Presigned URL");

            // B2: Upload th·∫≥ng l√™n S3 (Frontend -> S3)
            console.log("ƒêang upload l√™n S3...", urlData.url);
            // L∆∞u √Ω: N·∫øu ch∆∞a c√≥ S3 th·∫≠t, b∆∞·ªõc n√†y s·∫Ω l·ªói.
            // Demo Local: B·ªè qua b∆∞·ªõc n√†y ho·∫∑c d√πng Mock.

            // B3: G·ªçi API start ETL
            console.log("K√≠ch ho·∫°t ETL Job...");
            const startRes = await fetch(`${API_URL}/api/jobs/start_etl`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    file_key: urlData.file_key,
                    options: {
                        clean: document.getElementById('checkClean').checked,
                        ai: document.getElementById('checkAI').checked
                    }
                })
            });

            if (startRes.ok) {
                alert(" Job ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng! Lambda ƒëang ch·∫°y.");
                loadJobs();
            }

        } catch (error) {
            console.error(error);
            alert("L·ªói quy tr√¨nh: " + error.message);
        } finally {
            showLoading(false);
        }
    }

    // 3. H√†m l·∫•y danh s√°ch Job
    async function loadJobs() {
        const res = await fetch(`${API_URL}/api/jobs`);
        const jobs = await res.json();
        const tbody = document.getElementById('jobTableBody');
        tbody.innerHTML = '';

        jobs.forEach(job => {
            let badgeClass = 'bg-secondary';
            if(job.status === 'Completed') badgeClass = 'bg-success';
            if(job.status === 'Failed') badgeClass = 'bg-danger';
            if(job.status === 'Processing') badgeClass = 'bg-warning text-dark';

            const row = `
                <tr>
                    <td>#${job.id}</td>
                    <td>${job.filename}</td>
                    <td><span class="badge ${badgeClass}">${job.status}</span></td>
                    <td>${job.result_url ? `<a href="${job.result_url}" target="_blank">T·∫£i v·ªÅ</a>` : '-'}</td>
                    <td>${job.upload_time}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
</script>

</body>
</html>